{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>{% block title %}SwapPlace{% endblock %}</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">


<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
:root{
    --azul-principal: #0d6efd;   
    --celeste-claro: #e8f4ff;  
    --blanco: #ffffff;
    --azul-oscuro: #08345a;
}

body {
    background: var(--celeste-claro);
    color: #12202b;
}

  /* Navbar */
.navbar-swap {
    background: linear-gradient(180deg, var(--azul-principal), #0b5ed7);
    color: var(--blanco);
    box-shadow: 0 4px 18px rgba(8,20,40,0.12);
}
.navbar-swap .navbar-brand {
    font-weight: 700;
    color: var(--blanco);
    letter-spacing: 0.2px;
}
.navbar-swap .nav-user {
    display:flex;
    gap: 8px;
    align-items:center;
}
.badge-notif {
    background: #ff6b6b;
    color: #fff;
    font-size: 0.72rem;
    border-radius: 999px;
    padding: 2px 6px;
}

  /* Notificaciones (container) */
#notif-container {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 1200;
    width: 320px;
    max-width: calc(100% - 40px);
}
.notif-card {
    background: var(--blanco);
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 10px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    font-size: 14px;
    display: flex;
    justify-content: space-between;
    gap: 8px;
    align-items: center;
}
.notif-info { flex: 1; }
.notif-title { font-weight: 700; margin-bottom: 3px; color: #08345a; }
.notif-time { font-size: 12px; color: #6c757d; }
.small-btn { padding: .25rem .5rem; font-size: .8rem; }

.page-container {
    padding-top: 18px;
    padding-bottom: 36px;
    min-height: calc(100vh - 120px);
}


.nav-btn {
    border-radius: 8px;
    padding: .35rem .6rem;
    font-size: .85rem;
}
.nav-btn-outline {
    background: rgba(255,255,255,0.12);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.12);
}
.nav-btn-outline:hover {
    background: rgba(255,255,255,0.18);
    color: #fff;
}

@media (max-width: 767px) {
    .nav-user { gap: 6px; }
    .nav-brand-small { font-size: 1rem; }
}

</style>

{% block head %}{% endblock %}
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-swap">
<div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center" href="{% url 'home' %}">
    <img src="{% static 'img/logo Swap.png' %}" alt="logo" style="height:34px; width:34px; object-fit:contain; margin-right:8px; border-radius:6px;">
    <span class="nav-brand-small">SwapPlace</span>
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu" aria-controls="navMenu" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon" style="color: #fff"><i class="bi bi-list" style="font-size:1.2rem;color:#fff"></i></span>
    </button>

    <div class="collapse navbar-collapse" id="navMenu">
    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
    </ul>

    <div class="d-flex align-items-center nav-user">

        {% if request.user.is_authenticated %}
        <span class="text-white me-2">Hola, <strong>{{ request.user.username }}</strong></span>
        <!--Informacion-->
        <a href="{% url 'informacion' %}" class="btn nav-btn nav-btn-outline me-1 d-flex align-items-center" title="¿Quienes Somos?">
            <i class="bi bi-info-square-fill"><br></i></i>   ¿Quienes Somos?
        </a>
        <!-- Chats -->
        <a href="{% url 'chat_list' %}" class="btn nav-btn nav-btn-outline me-1 d-flex align-items-center" title="Chats">
            <i class="bi bi-chat-dots-fill me-1"></i> Chats
        </a>
        <!-- Cerrar sesión -->
        <a href="{% url 'logout' %}" class="btn nav-btn btn-danger ms-1 d-flex align-items-center" title="Cerrar sesión">
            <i class="bi bi-box-arrow-right me-1"></i> Cerrar sesión
        </a>

        {% else %}
        <a href="{% url 'login' %}" class="btn nav-btn nav-btn-outline me-2 d-flex align-items-center">
            <i class="bi bi-box-arrow-in-right me-1"></i> Iniciar sesión
        </a>
        <a href="{% url 'registro' %}" class="btn nav-btn btn-light d-flex align-items-center">
            <i class="bi bi-person-plus me-1"></i> Registrarse
        </a>
        {% endif %}

    </div>
    </div>
</div>
</nav>

<div id="notif-container"></div>


<div class="container page-container">
<div class="row">
    <div class="col-12">
    {% block content %}{% endblock %}
    </div>
</div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
        }
    }
    }
    return cookieValue;
}

{% if request.user.is_authenticated %}

async function fetchNotifs() {
    try {
    const res = await fetch("{% url 'api_notificaciones' %}");
    if (!res.ok) return;
    const data = await res.json();
    const container = document.getElementById('notif-container');
    container.innerHTML = '';
    const now = new Date();
    data.notificaciones.forEach(n => {
        if (n.edad_segundos > 3600) return; 
        const div = document.createElement('div');
        div.className = 'notif-card';
        const info = document.createElement('div');
        info.className = 'notif-info';
        info.innerHTML = `<div class="notif-title">${n.titulo}</div>
                        <div>${n.mensaje}</div>
                        <div class="notif-time">${new Date(n.creado_iso).toLocaleString()}</div>`;
        const actions = document.createElement('div');
        actions.innerHTML = `${ n.link ? `<a href="${n.link}" class="btn btn-sm btn-primary small-btn me-1">Ver</a>` : '' }
                            <button class="btn btn-sm btn-outline-secondary small-btn" onclick="marcar(${n.id}, this)">X</button>`;
        div.appendChild(info);
        div.appendChild(actions);
        container.appendChild(div);
    });
    } catch (e) {
    console.error('fetchNotifs error', e);
    }
}

async function marcar(id, btn) {
    try {
    const form = new FormData();
    form.append('id', id);
    const res = await fetch("{% url 'api_marcar_leida' %}", {
        method: 'POST',
        headers: {'X-CSRFToken': getCookie('csrftoken')},
        body: form
    });
    if (res.ok) {
        btn.closest('.notif-card').remove();
    }
    } catch (e) { console.error(e); }
}

fetchNotifs();
setInterval(fetchNotifs, 30000);
{% endif %}
</script>

{% block scripts %}{% endblock %}
</body>
</html>
