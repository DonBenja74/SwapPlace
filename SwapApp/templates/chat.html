{% extends 'base.html' %}
{% load static %}

{% block title %}Chats - SwapPlace{% endblock %}

{% block content %}
<style>
#calificacionOverlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 3000;
    justify-content: center;
    align-items: center;
}
.calificacion-card {
    background: #fff;
    border-radius: 12px;
    padding: 22px;
    width: 360px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.18);
}
.star { font-size: 2rem; color: #cfcfcf; cursor:pointer; margin: 0 6px; }
.star.selected { color: #FFD700; transform: scale(1.05); }

#chat-list .list-group-item { border-radius:8px; margin-bottom:6px; }

#chat-box {
    background: rgba(110,201,255,0.06);
    border-radius:12px;
    padding:12px;
    height:260px; 
    overflow-y:auto;
    border:1px solid #e3f3ff;
}

.bubble {
    display:inline-block;
    padding:10px 14px;
    border-radius:14px;
    max-width:78%;
    margin:6px 0;
}
.bubble.me { background:#0d6efd; color:#fff; border-bottom-right-radius:4px; }
.bubble.them { background:#fff; color:#222; border:1px solid rgba(10,20,40,0.06); border-bottom-left-radius:4px; }

/* Recomendaciones cards */
.reco-card { border-radius:12px; overflow:hidden; }
.reco-img { height:140px; object-fit:cover; display:block; width:100%; }
.reco-title { font-size:0.95rem; font-weight:700; margin-bottom:6px; }
.reco-desc { font-size:0.82rem; color:#6c757d; margin-bottom:8px; }
</style>

<div class="row mt-4">

  <div class="col-md-4">
    <h5 class="text-primary">Chats</h5>
    <div class="list-group" id="chat-list">
      {% for chat in chats|dictsortreversed:"creado" %}
        <a href="{% url 'chat_detalle' chat.id %}"
          class="list-group-item list-group-item-action {% if chat_seleccionado and chat.id == chat_seleccionado.id %}active{% endif %}">
          <div class="fw-semibold">{{ chat.trueque.producto.nombre }}</div>
          <div class="small text-muted">Iniciado: {{ chat.creado|date:"d/m/Y H:i" }}</div>
        </a>
      {% empty %}
        <div class="card p-3"><div class="text-muted">No tienes chats aún.</div></div>
      {% endfor %}
    </div>
  </div>

  <div class="col-md-8">
    {% if chat_seleccionado %}
      <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
          <h5 class="mb-0 text-primary">Chat con
            {% for u in chat_seleccionado.usuarios.all %}
              {% if u != user %}
                <span class="fw-semibold">{{ u.username }}</span>
              {% endif %}
            {% endfor %}
          </h5>
          <div class="text-muted-small">Trueque: <em>{{ chat_seleccionado.trueque.producto.nombre }}</em></div>
        </div>

        <div class="btn-group">
          <button id="btn-reportar" class="btn btn-outline-danger btn-sm">Reportar</button>
          <button id="btn-calificar" class="btn btn-outline-warning btn-sm">Calificar</button>
        </div>
      </div>

      <div id="chat-box">
        {% for mensaje in chat_seleccionado.mensajes.all %}
          <div class="{% if mensaje.autor == user %}text-end{% else %}text-start{% endif %}" data-msg-id="{{ mensaje.id }}">
            <div class="bubble {% if mensaje.autor == user %}me{% else %}them{% endif %}">
              <div class="small text-muted mb-1"><strong>{{ mensaje.autor.username }}</strong></div>
              <div>{{ mensaje.contenido }}</div>
              <div class="small text-muted mt-1">{{ mensaje.fecha|date:"d/m/Y H:i" }}</div>
            </div>
          </div>
        {% empty %}
          <p class="text-muted">No hay mensajes aún.</p>
        {% endfor %}
      </div>

      <form id="chat-form" method="post" action="{% url 'api_send_message' chat_seleccionado.id %}">
        {% csrf_token %}
        <div class="input-group mt-2">
          <input type="text" id="mensaje" name="mensaje" maxlength="500"
                class="form-control" placeholder="Escribe tu mensaje...">
          <button type="submit" class="btn btn-primary">Enviar</button>
        </div>
      </form>

      <!-- ================================================= -->
      <!-- RECOMENDACIONES PERSONALIZADAS -->
      <!-- ================================================= -->
      <div class="mt-4">
        <h5 class="text-primary">Recomendaciones personalizadas</h5>
        <div class="small text-muted mb-2" id="reco-subtitle">Otros productos de <span id="reco-username">...</span></div>
        <div id="recom-container" class="row g-3"></div>
      </div>

      <script>
      // Leer token CSRF desde el formulario ya presente
      function getCsrfToken() {
          const el = document.querySelector('[name=csrfmiddlewaretoken]');
          return el ? el.value : '';
      }

      // Carga los productos del otro usuario vía tu endpoint api_productos_usuario_chat
      async function cargarRecomendaciones() {
          const urlTemplate = "{% url 'api_productos_usuario_chat' 0 %}";
          // urlTemplate tiene un /0/ que reemplazamos por el id de chat seleccionado
          const url = urlTemplate.replace('/0/', "/{{ chat_seleccionado.id }}/");

          try {
              const res = await fetch(url);
              if (!res.ok) {
                  console.error("No se pudieron cargar recomendaciones:", res.status);
                  return;
              }

              const data = await res.json();
              const cont = document.getElementById("recom-container");
              const subtitleUser = document.getElementById("reco-username");
              cont.innerHTML = "";

              if (!data.productos || data.productos.length === 0) {
                  cont.innerHTML = `<div class='text-muted'>Este usuario no tiene productos publicados.</div>`;
                  return;
              }

              // Mostrar hasta 3 productos
              data.productos.slice(0,3).forEach(p => {
                  
                  {% for u in chat_seleccionado.usuarios.all %}
                    {% if u != user %}
                      subtitleUser.innerText = "{{ u.username }}";
                    {% endif %}
                  {% endfor %}

                  const divCol = document.createElement("div");
                  divCol.className = "col-md-4";

                  // Botón para ofrecer trueque: hará POST a la misma ruta del chat (window.location.pathname)
                  divCol.innerHTML = `
                  <div class="card shadow-sm h-100 reco-card">
                      <img src="${p.imagen}" class="reco-img" onerror="this.src='/static/img/Nofoto.png'">
                      <div class="card-body d-flex flex-column">
                          <div class="reco-title">${escapeHtml(p.nombre)}</div>
                          <div class="reco-desc">${escapeHtml(p.descripcion)}</div>

                          <div class="mt-auto">
                              <form class="ofrecerTruequeForm" data-producto-id="${p.id}">
                                  <input type="hidden" name="action" value="ofrecer_trueque">
                                  <input type="hidden" name="producto_id" value="${p.id}">
                                  <button type="submit" class="btn btn-primary w-100 btn-sm">Ofrecer trueque</button>
                              </form>
                          </div>
                      </div>
                  </div>
                  `;

                  cont.appendChild(divCol);
              });

              // Attach handlers after appending
              document.querySelectorAll(".ofrecerTruequeForm").forEach(form => {
                  form.addEventListener("submit", async (e) => {
                      e.preventDefault();
                      const productoId = form.getAttribute("data-producto-id");
                      await ofrecerTruequeDesdeChat(productoId, form);
                  });
              });

          } catch (err) {
              console.error("Error cargando recomendaciones:", err);
          }
      }

      // Envía el POST para crear trueque usando la ruta del chat actual (evita dependencias de nombres de URL)
      async function ofrecerTruequeDesdeChat(productoId, formEl=null) {
          const path = window.location.pathname; // ej: /chat/1/
          const token = getCsrfToken();
          const body = new URLSearchParams();
          body.append("action", "ofrecer_trueque");
          body.append("producto_id", productoId);

          try {
              const res = await fetch(path, {
                  method: "POST",
                  headers: {
                      "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
                      "X-CSRFToken": token
                  },
                  body: body.toString()
              });

              // Si tu view redirige (302) el fetch seguirá la redirección automáticamente.
              // Intentamos leer JSON, pero si responde con redirect/HTML, asumimos éxito si ok.
              if (res.ok) {
                  // Mostrar feedback y actualizar botones si fuera necesario
                  mostrarToast("Solicitud de trueque enviada.", "success");
                  // Opcional: deshabilitar el botón
                  if (formEl) {
                      const btn = formEl.querySelector("button");
                      if (btn) { btn.innerText = "Enviado"; btn.disabled = true; }
                  }
              } else {
                  // Intentar leer cuerpo con mensaje
                  let txt = await res.text();
                  console.error("Error al ofrecer trueque:", res.status, txt);
                  mostrarToast("Error enviando oferta", "danger");
              }
          } catch (err) {
              console.error("Error en fetch ofrecerTrueque:", err);
              mostrarToast("Error de conexión", "danger");
          }
      }

      // Inicializa recomendaciones en carga
      cargarRecomendaciones();
      </script>

    {% else %}
      <div class="text-muted">Selecciona un chat para comenzar a conversar.</div>
    {% endif %}
  </div>
</div>

<!-- Overlay de calificación -->
<div id="calificacionOverlay">
  <div class="calificacion-card text-center">
    <button id="cerrarCalif" class="btn-close float-end" aria-label="Cerrar"></button>
    <h4 class="mb-2">Calificar vendedor</h4>
    <p class="text-muted-small mb-2">Selecciona tu calificación:</p>

    <div id="ratingStars" class="mb-3">
      {% for i in "12345" %}
        <span class="star" data-value="{{ forloop.counter }}">★</span>
      {% endfor %}
    </div>

    <button id="enviarCalif" class="btn btn-warning w-100">Enviar Calificación</button>
  </div>
</div>

<!-- Toast -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:3000;">
  <div id="toastSwap" class="toast align-items-center text-bg-success border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toastMessage">Acción completada</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script>
function mostrarToast(msg, tipo='success') {
  const toastEl = document.getElementById('toastSwap');
  const toastMsg = document.getElementById('toastMessage');
  if (!toastEl || !toastMsg) return;
  toastMsg.innerText = msg;
  toastEl.className = `toast align-items-center text-bg-${tipo} border-0`;
  new bootstrap.Toast(toastEl).show();
}

function escapeHtml(t) {
  return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;")
          .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
          .replace(/'/g,"&#039;");
}

const chatId = "{{ chat_seleccionado.id }}" || null;
let lastMessageId = 0;

(function initLastId() {
  const box = document.getElementById('chat-box');
  if (!box) return;
  box.querySelectorAll('[data-msg-id]').forEach(n=>{
    const id = parseInt(n.getAttribute('data-msg-id'));
    if (id > lastMessageId) lastMessageId = id;
  });
  box.scrollTop = box.scrollHeight;
})();

if (chatId) {
  setInterval(async () => {
    try {
      const urlTemplate = "{% url 'api_fetch_messages' 0 %}";
      const url = urlTemplate.replace('/0/', `/${chatId}/`) + "?since_id=" + lastMessageId;
      const res = await fetch(url);
      if (!res.ok) return;
      const data = await res.json();
      if (!data.mensajes) return;
      const box = document.getElementById('chat-box');
      if (!box) return;
      data.mensajes.forEach(m => {
        if (m.id <= lastMessageId) return;
        const wrapper = document.createElement('div');
        wrapper.className = (m.autor === "{{ user.username }}") ? "text-end" : "text-start";
        wrapper.setAttribute("data-msg-id", m.id);
        wrapper.innerHTML = `
          <div class="bubble ${m.autor === "{{ user.username }}" ? 'me' : 'them'}">
            <div class="small text-muted mb-1"><strong>${escapeHtml(m.autor)}</strong></div>
            <div>${escapeHtml(m.contenido)}</div>
            <div class="small text-muted mt-1">${escapeHtml(m.fecha)}</div>
          </div>`;
        box.appendChild(wrapper);
        lastMessageId = m.id;
        box.scrollTop = box.scrollHeight;
      });
    } catch (err) {
      console.error("Error en polling:", err);
    }
  }, 2000);
}

const chatForm = document.getElementById("chat-form");
if (chatForm) {
  chatForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const input = document.getElementById("mensaje");
    if (!input) return;
    const texto = input.value.trim();
    if (!texto) return;

    const urlTemplate = "{% url 'api_send_message' 0 %}";
    const url = urlTemplate.replace('/0/', `/${chatId}/`);

    try {
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
        },
        body: JSON.stringify({ texto })
      });

      const data = await res.json();
      if (res.ok && data.ok) {
        input.value = "";
      } else {
        mostrarToast(data.error || 'Error enviando mensaje', 'danger');
      }
    } catch (err) {
      console.error(err);
      mostrarToast('Error de conexión', 'danger');
    }
  });
}

const btnReportar = document.getElementById("btn-reportar");
if (btnReportar) {
  btnReportar.addEventListener("click", () => {
    mostrarToast(
      "El equipo de soporte revisará el reporte y enviará respuesta dentro de 72 hrs.",
      "danger"
    );
  });
}

const overlay = document.getElementById("calificacionOverlay");
const btnCalificar = document.getElementById("btn-calificar");
const cerrarCalifBtn = document.getElementById("cerrarCalif");
const enviarCalifBtn = document.getElementById("enviarCalif");
const stars = document.querySelectorAll(".star");
let calificacion = 0;

if (btnCalificar) btnCalificar.addEventListener("click", () => {
  overlay.style.display = "flex";
});

if (cerrarCalifBtn) cerrarCalifBtn.addEventListener("click", () => {
  overlay.style.display = "none";
});

stars.forEach((s, i) => {
  s.addEventListener("click", () => {
    calificacion = i + 1;
    stars.forEach(st => st.classList.remove("selected"));
    for (let j = 0; j <= i; j++) stars[j].classList.add("selected");
  });
});

if (enviarCalifBtn) {
  enviarCalifBtn.addEventListener("click", async () => {
    if (!calificacion)
      return mostrarToast("Selecciona una estrella", "warning");

    try {
      const urlTemplate = "{% url 'api_calificar_vendedor' 0 %}";
      const url = urlTemplate.replace('/0/', `/${chatId}/`);

      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
        },
        body: JSON.stringify({ estrellas: calificacion })
      });

      const data = await res.json();

      if (res.ok && data.ok) {
        overlay.style.display = "none";
        mostrarToast(`Calificación enviada: ${calificacion} ⭐`);
      } else {
        mostrarToast(data.error || "Error enviando calificación", "danger");
      }
    } catch (err) {
      console.error(err);
      mostrarToast("Error de conexión", "danger");
    }
  });
}
</script>
{% endblock %}
