{% extends 'base.html' %}
{% load static %}
{% block title %}Home - SwapPlace{% endblock %}

{% block content %}

<div class="d-flex align-items-center mb-3">
    <div>
        <h3 class="mb-0">Últimos productos</h3>
        <div class="text-muted-small">Explora y ofrece trueques</div>
    </div>
    <div class="ms-auto d-flex gap-2">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalCrear">
            + Agregar producto
        </button>
    </div>
</div>

<div class="mb-4">
    <input type="text" id="buscador"
        placeholder="Buscar productos o usuarios..."
        class="form-control">
</div>

{% if trueques_pendientes %}
<div class="card mb-3">
    <div class="card-body">
        <h5 class="mb-3">Solicitudes de trueque</h5>
        {% for t in trueques_pendientes %}
        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
            <div>
                <strong class="me-1">{{ t.solicitante.username }}</strong>
                le interesó
                <strong class="ms-1">{{ t.producto.nombre }}</strong>
                <div class="small text-muted">{{ t.fecha|date:"d/m/Y H:i" }}</div>
            </div>
            <div>
                <form method="post" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="responder_trueque">
                    <input type="hidden" name="trueque_id" value="{{ t.id }}">
                    <button name="decision" value="aceptar" class="btn btn-success btn-sm me-1">Aceptar</button>
                    <button name="decision" value="rechazar" class="btn btn-danger btn-sm">Rechazar</button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Información de paginación -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="text-muted">
        Mostrando {{ productos.start_index }} - {{ productos.end_index }} de {{ productos.paginator.count }} productos
    </div>
    <div class="text-muted">
        Página {{ productos.number }} de {{ productos.paginator.num_pages }}
    </div>
</div>

<div class="row" id="contenedor-productos">

    {% for p in productos %}
    <div class="col-md-4 mb-4 item-producto">
        <div class="card h-100">

            {% if p.imagen %}
                <img src="{{ p.imagen.url }}" class="card-img-top" style="height:220px; object-fit:cover;">
            {% else %}
                <img src="{% static 'img/Nofoto.png' %}" class="card-img-top" style="height:220px; object-fit:cover;">
            {% endif %}

            <div class="card-body d-flex flex-column">
                <h5 class="card-title">{{ p.nombre }}</h5>
                <p class="card-text text-truncate">{{ p.descripcion|truncatechars:120 }}</p>

                <div class="mt-auto d-flex justify-content-between align-items-center">
                    <small class="text-muted-small">Publicado por {{ p.usuario.username }}</small>
                    <div>

                        {% if request.user == p.usuario or request.user.username == 'admin3000' %}
                            <button class="btn btn-outline-secondary btn-sm me-1" data-bs-toggle="modal" data-bs-target="#modalEditar{{ p.id }}">Editar</button>

                            <form method="post" style="display:inline;">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="eliminar_producto">
                                <input type="hidden" name="producto_id" value="{{ p.id }}">
                                <button class="btn btn-danger btn-sm" onclick="return confirm('¿Eliminar producto?')">Eliminar</button>
                            </form>

                            <!-- MODAL EDITAR -->
                            <div class="modal fade" id="modalEditar{{ p.id }}" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                        <form method="post" enctype="multipart/form-data">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="editar_producto">
                                            <input type="hidden" name="producto_id" value="{{ p.id }}">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Editar producto</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="mb-2">
                                                    <label class="form-label">Nombre</label>
                                                    <input name="nombre" class="form-control" value="{{ p.nombre }}" required>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label">Descripción</label>
                                                    <textarea name="descripcion" class="form-control" rows="3" required>{{ p.descripcion }}</textarea>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label">Imagen</label>
                                                    <input type="file" name="imagen" class="form-control">
                                                    {% if p.imagen %}
                                                        <img src="{{ p.imagen.url }}" class="img-fluid mt-2" style="max-height:120px;">
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button class="btn btn-primary" type="submit">Guardar</button>
                                                <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>

                        {% else %}
                            <form method="post" style="display:inline;">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="ofrecer_trueque">
                                <input type="hidden" name="producto_id" value="{{ p.id }}">
                                <button class="btn btn-primary btn-sm">Ofrecer trueque</button>
                            </form>
                        {% endif %}

                    </div>
                </div>

            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="alert alert-info text-center">
            No hay productos disponibles en este momento.
        </div>
    </div>
    {% endfor %}

</div>

<!-- PAGINACIÓN MEJORADA -->
{% if productos.paginator.num_pages > 1 %}
<div class="d-flex justify-content-center mt-4 mb-4">
    <nav aria-label="Navegación de páginas">
        <ul class="pagination pagination-lg">

            <!-- Primera página -->
            {% if productos.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1" aria-label="Primera">
                        <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                </li>
            {% endif %}

            <!-- Página anterior -->
            {% if productos.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ productos.previous_page_number }}" aria-label="Anterior">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">&laquo;</span>
                </li>
            {% endif %}

            <!-- Números de página con rango limitado -->
            {% for num in productos.paginator.page_range %}
                {% if productos.number == num %}
                    <li class="page-item active" aria-current="page">
                        <span class="page-link">{{ num }}</span>
                    </li>
                {% elif num > productos.number|add:'-3' and num < productos.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                    </li>
                {% endif %}
            {% endfor %}

            <!-- Página siguiente -->
            {% if productos.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ productos.next_page_number }}" aria-label="Siguiente">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">&raquo;</span>
                </li>
            {% endif %}

            <!-- Última página -->
            {% if productos.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ productos.paginator.num_pages }}" aria-label="Última">
                        <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                </li>
            {% endif %}

        </ul>
    </nav>
</div>
{% endif %}

<!-- MODAL CREAR -->
<div class="modal fade" id="modalCrear" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="action" value="crear_producto">
                <div class="modal-header">
                    <h5 class="modal-title">Agregar producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2">
                        <label class="form-label">Nombre</label>
                        <input name="nombre" class="form-control" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Descripción</label>
                        <textarea name="descripcion" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Imagen</label>
                        <input type="file" name="imagen" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" type="submit">Guardar</button>
                    <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!--  SCRIPT PARA BÚSQUEDA EN TIEMPO REAL  -->
<script>
const input = document.getElementById("buscador");
const contenedor = document.getElementById("contenedor-productos");
let buscando = false;

input.addEventListener("input", async () => {
    const q = input.value.trim();

    // Si el campo está vacío, recargar la página para mostrar la paginación
    if (q === "") {
        window.location.href = window.location.pathname;
        return;
    }

    buscando = true;

    try {
        const resp = await fetch(/buscar-productos/?q= + encodeURIComponent(q));
        const data = await resp.json();

        contenedor.innerHTML = "";

        if (data.productos.length === 0) {
            contenedor.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        No se encontraron productos que coincidan con tu búsqueda.
                    </div>
                </div>
            `;
            return;
        }

        data.productos.forEach(p => {
            let botones = "";

            if (p.es_dueno) {
                botones = `
                    <button class="btn btn-outline-secondary btn-sm me-1" 
                            onclick="alert('Edita desde la vista principal')">
                        Editar
                    </button>
                    <form method="post" style="display:inline;">
                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                        <input type="hidden" name="action" value="eliminar_producto">
                        <input type="hidden" name="producto_id" value="${p.id}">
                        <button class="btn btn-danger btn-sm" 
                                onclick="return confirm('¿Eliminar producto?')">
                            Eliminar
                        </button>
                    </form>
                `;
            } else {
                botones = `
                    <form method="post" style="display:inline;">
                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                        <input type="hidden" name="action" value="ofrecer_trueque">
                        <input type="hidden" name="producto_id" value="${p.id}">
                        <button class="btn btn-primary btn-sm">Ofrecer trueque</button>
                    </form>
                `;
            }

            contenedor.innerHTML += `
                <div class="col-md-4 mb-4 item-producto">
                    <div class="card h-100">
                        <img src="${p.imagen}" class="card-img-top" style="height:220px; object-fit:cover;">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${p.nombre}</h5>
                            <p class="card-text text-truncate">${p.descripcion}</p>

                            <div class="mt-auto d-flex justify-content-between align-items-center">
                                <small class="text-muted-small">Publicado por ${p.usuario}</small>
                                <div>${botones}</div>
                            </div>

                        </div>
                    </div>
                </div>
            `;
        });
    } catch (error) {
        console.error('Error en la búsqueda:', error);
        contenedor.innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger text-center">
                    Error al realizar la búsqueda. Por favor, intenta de nuevo.
                </div>
            </div>
        `;
    }
});

// Restaurar paginación al limpiar búsqueda
input.addEventListener("blur", () => {
    if (input.value.trim() === "" && buscando) {
        buscando = false;
    }
});
</script>

{% endblock %}